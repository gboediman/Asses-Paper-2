<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Grading System (Firebase & Gemini)</title>
    <!-- Mammoth.js for DOCX parsing -->
    <!-- You can download it from: https://cdnjs.cloudflare.com/ajax/libs/mammoth.js/1.6.0/mammoth.browser.min.js -->
    <script src="./mammoth.browser.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        console.log("Script execution started."); // Log untuk melacak eksekusi skrip

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables from Canvas environment (if available)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // User's provided Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBa7awCuSQMYmu8eI5C2_fgdKFAmb-el-o",
            authDomain: "essay-submission-01.firebaseapp.com",
            projectId: "essay-submission-01",
            storageBucket: "essay-submission-01.firebasestorage.app",
            messagingSenderId: "350453357928",
            appId: "1:350453357928:web:20bb9404442337b0708add"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null; // To store the authenticated user ID

        // Default rubric settings for 6th-grade essays
        const defaultRubricSettings = [
            { id: 'main-idea', title: 'Main Idea', description: 'Clearly states the main point of the essay.', weight: '30' },
            { id: 'supporting-details', title: 'Supporting Details', description: 'Provides relevant and sufficient details to support the main idea.', weight: '40' },
            { id: 'sentence-structure', title: 'Sentence Structure & Grammar', description: 'Uses varied sentence structures and demonstrates good grammar and spelling.', weight: '30' },
        ];

        let rubricSettings = []; // This will be populated from Firestore

        // Gemini API Key
        const GEMINI_API_KEY = "AIzaSyAq71Famse8z1JTjMJw9NaXQSG3a7Ea0eU";

        // Firebase Authentication Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Firebase authenticated. User ID:", currentUserId);
                // Load rubric settings after authentication
                await loadRubricSettings();
            } else {
                currentUserId = null;
                console.log("Firebase not authenticated. Signing in anonymously...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during anonymous sign-in:", error);
                    showMessage("Authentication failed. Some features may not work.", 'error');
                }
            }
        });

        async function loadRubricSettings() {
            if (!currentUserId) {
                console.warn("Cannot load rubric settings: User not authenticated.");
                return;
            }
            const rubricDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings`, "rubric");
            try {
                const docSnap = await getDoc(rubricDocRef);
                if (docSnap.exists()) {
                    // Convert weights back to string for input fields
                    rubricSettings = docSnap.data().criteria.map(c => ({
                        ...c,
                        weight: String(c.weight)
                    })) || [];
                    console.log("Rubric settings loaded from Firestore:", rubricSettings);
                } else {
                    console.log("No rubric settings found in Firestore. Saving default settings.");
                    rubricSettings = defaultRubricSettings;
                    await saveRubricSettings(); // Save defaults if not found
                }
                renderRubricSettings(); // Render after loading/setting defaults
            } catch (error) {
                console.error("Error loading rubric settings:", error);
                showMessage("Failed to load rubric settings. Using default settings.", 'error');
                rubricSettings = defaultRubricSettings; // Fallback to defaults on error
                renderRubricSettings();
            }
        }

        async function saveRubricSettings() {
            if (!currentUserId) {
                showMessage("Cannot save settings: User not authenticated.", 'error');
                return;
            }
            const rubricDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings`, "rubric");
            try {
                await setDoc(rubricDocRef, { criteria: rubricSettings.map(c => ({
                    id: c.id,
                    title: c.title,
                    description: c.description,
                    weight: parseInt(c.weight || '0') // Ensure weight is saved as number
                }))});
                console.log("Rubric settings saved to Firestore.");
                calculateTotalWeight(); // Recalculate and display total weight
                showMessage("Settings saved successfully!", 'success');
            } catch (error) {
                console.error("Error saving rubric settings:", error);
                showMessage("Failed to save settings.", 'error');
            }
        }

        // --- Utility Functions ---
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            messageBox.classList.add('block');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('hidden');
        }

        function clearResults() {
            document.getElementById('aiDetectionResults').classList.add('hidden');
            document.getElementById('rubricAssessmentResults').classList.add('hidden');
            hideMessage();
        }

        // --- View Switching ---
        function setupViewSwitching() {
            const studentViewBtn = document.getElementById('studentViewBtn');
            const teacherViewBtn = document.getElementById('teacherViewBtn');
            const studentView = document.getElementById('studentView');
            const teacherSettings = document.getElementById('teacherSettings');

            studentViewBtn.addEventListener('click', () => {
                studentView.classList.remove('hidden');
                teacherSettings.classList.add('hidden');
                studentViewBtn.classList.add('bg-blue-600', 'text-white');
                studentViewBtn.classList.remove('text-gray-600', 'hover:text-blue-600');
                teacherViewBtn.classList.remove('bg-blue-600', 'text-white');
                teacherViewBtn.classList.add('text-gray-600', 'hover:text-blue-600');
                clearResults(); // Clear results when switching views
                lucide.createIcons(); // Re-render Lucide icons
            });

            teacherViewBtn.addEventListener('click', () => {
                studentView.classList.add('hidden');
                teacherSettings.classList.remove('hidden');
                teacherViewBtn.classList.add('bg-blue-600', 'text-white');
                teacherViewBtn.classList.remove('text-gray-600', 'hover:text-blue-600');
                studentViewBtn.classList.remove('bg-blue-600', 'text-white');
                studentViewBtn.classList.add('text-gray-600', 'hover:text-blue-600');
                renderRubricSettings(); // Render settings when view is active
                lucide.createIcons(); // Re-render Lucide icons
            });
        }

        // --- File Upload ---
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const chooseFileBtn = document.getElementById('chooseFileBtn');
            const fileInfo = document.getElementById('fileInfo');
            const fileNameSpan = document.getElementById('fileName');
            const fileSizeSpan = document.getElementById('fileSize');
            const extractedTextPreview = document.getElementById('extractedTextPreview');
            const previewText = document.getElementById('previewText');
            const submitBtn = document.getElementById('submitBtn');

            let currentFile = null;
            let extractedDocText = '';

            chooseFileBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', async (event) => {
                const uploadedFile = event.target.files[0];
                if (uploadedFile && uploadedFile.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    currentFile = uploadedFile;
                    fileNameSpan.textContent = uploadedFile.name;
                    fileSizeSpan.textContent = (uploadedFile.size / 1024).toFixed(1);
                    fileInfo.classList.remove('hidden');
                    submitBtn.disabled = false;
                    clearResults();
                    hideMessage();

                    try {
                        if (typeof mammoth === 'undefined' || !mammoth.extractRawText) {
                            throw new Error('mammoth.js is not loaded or ready. Make sure "mammoth.browser.min.js" is in the same directory as index.html.');
                        }
                        const arrayBuffer = await uploadedFile.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        extractedDocText = result.value;
                        previewText.textContent = extractedDocText.substring(0, 500) + (extractedDocText.length > 500 ? '...' : '');
                        extractedTextPreview.classList.remove('hidden');
                    } catch (error) {
                        console.error('Error extracting text from DOCX:', error);
                        showMessage(`Error reading document: ${error.message}. Make sure it's a valid .docx file and try again.`, 'error');
                        submitBtn.disabled = true;
                        extractedTextPreview.classList.add('hidden');
                    }
                } else {
                    showMessage('Please upload only .docx files.', 'error');
                    currentFile = null;
                    extractedDocText = '';
                    fileInfo.classList.add('hidden');
                    submitBtn.disabled = true;
                    extractedTextPreview.classList.add('hidden');
                }
            });
        } // Penutup untuk setupFileUpload()

            // --- Gemini API Calls ---
            async function callGemini(prompt, isJson = false, schema = null) {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                if (isJson) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    };
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

                let response;
                let result;
                let retries = 0;
                const maxRetries = 3;
                const baseDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) { // Too Many Requests
                            retries++;
                            const delay = baseDelay * Math.pow(2, retries - 1);
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds... (Attempt ${retries}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Gemini API error: ${response.status} - ${errorData.error || response.statusText}`);
                        }

                        result = await response.json();
                        break; // Success, exit loop
                    } catch (error) {
                        console.error('Gemini call error:', error);
                        if (retries === maxRetries - 1) throw error; // Re-throw on last retry
                        retries++;
                        const delay = baseDelay * Math.pow(2, retries - 1);
                        console.warn(`Error during API call. Retrying in ${delay / 1000} seconds... (Attempt ${retries}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJson ? JSON.parse(text) : text;
                } else {
                    throw new Error("Gemini API response structure unexpected or content missing.");
                }
            }

            async function detectAIContent(text) {
                showMessage('🤖 Analyzing text for AI content using Gemini...', 'info');
                const prompt = `You are an AI detection system. Analyze the following text and determine the probability that this text was written by an AI. Provide your response in JSON format with the following structure:
{
  "ai_probability": <integer_percentage_0_100>,
  "confidence": <integer_confidence_level_0_100>,
  "flags": ["list", "of", "specific", "flags", "e.g.", "repetitive phrases", "unnatural phrasing", "unvaried sentence structure"]
}

Text to analyze:
"${text}"`;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        "ai_probability": { "type": "NUMBER" },
                        "confidence": { "type": "NUMBER" },
                        "flags": { "type": "ARRAY", "items": { "type": "STRING" } }
                    },
                    "propertyOrdering": ["ai_probability", "confidence", "flags"]
                };

                try {
                    const result = await callGemini(prompt, true, schema);
                    hideMessage();
                    return {
                        probability: result.ai_probability || 0,
                        confidence: result.confidence || 0,
                        flags: result.flags || [],
                        wordCount: text.split(/\s+/).filter(word => word.length > 0).length,
                        sentenceCount: text.split(/[.!?]\s*/).filter(s => s.trim().length > 10).length,
                        avgSentenceLength: Math.round(text.split(/[.!?]\s*/).filter(s => s.trim().length > 10)
                            .reduce((acc, s) => acc + s.split(/\s+/).filter(word => word.length > 0).length, 0) /
                            (text.split(/[.!?]\s*/).filter(s => s.trim().length > 10).length || 1))
                    };
                } catch (error) {
                    console.error('AI Detection Error:', error);
                    showMessage('AI detection failed. Using fallback analysis. Ensure Gemini API key is valid and service is available.', 'error');
                    const sentences = text.split(/[.!?]\s*/).filter(s => s.trim().length > 20);
                    const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                    const avgSentenceLength = sentences.reduce((acc, s) => acc + s.split(/\s+/).filter(word => word.length > 0).length, 0) / (sentences.length || 1);

                    return {
                        probability: Math.floor(Math.random() * 30),
                        confidence: 75,
                        flags: ['Service unavailable - using fallback analysis'],
                        wordCount,
                        sentenceCount: sentences.length,
                        avgSentenceLength: Math.round(avgSentenceLength)
                    };
                }
            }

            async function scoreWithGeminiRubric(essayText, rubricCriteria) {
                showMessage('📊 Scoring essay with Gemini rubric...', 'info');
                let totalScore = 0;
                let totalWeight = 0;
                let detailedRubricFeedback = {};
                let overallCommentText = "";

                try {
                    for (const criterion of rubricCriteria) {
                        const criterionPrompt = `Using a scale of 1-5, where 1 is "Needs Significant Improvement" and 5 is "Excellent," score the following essay based on the criterion: "${criterion.title}: ${criterion.description}". Provide a detailed narrative feedback for this criterion, several sentences long, explaining your score.
                        \nEssay:\n"${essayText}"\n\nResponse format: {"score": [1-5], "feedback": "Your detailed narrative feedback here."}`;

                        const schema = {
                            type: "OBJECT",
                            properties: {
                                "score": { "type": "NUMBER" },
                                "feedback": { "type": "STRING" }
                            },
                            "propertyOrdering": ["score", "feedback"]
                        };

                        const jsonResponse = await callGemini(criterionPrompt, true, schema);
                        const score = jsonResponse.score;
                        const feedback = jsonResponse.feedback;

                        detailedRubricFeedback[criterion.title] = { score, feedback };
                        totalScore += (score * parseInt(criterion.weight || '0'));
                        totalWeight += parseInt(criterion.weight || '0');
                    }

                    // Generate overall comment
                    const overallCommentPrompt = `Based on the following rubric feedback for an essay, provide an overall narrative comment. This should be a detailed narrative and several paragraphs long, providing comprehensive insights.
                    \nRubric Feedback:\n${JSON.stringify(detailedRubricFeedback, null, 2)}\n\nEssay:\n"${essayText}"`;

                    overallCommentText = await callGemini(overallCommentPrompt);

                    // Ensure final score does not exceed 100
                    const finalCalculatedScore = Math.min(100, (totalWeight > 0) ? Math.round((totalScore / totalWeight) * 100) : 0);

                    return {
                        individualScores: detailedRubricFeedback,
                        totalScore: finalCalculatedScore,
                        breakdown: rubricCriteria.map(c => ({
                            ...c,
                            score: detailedRubricFeedback[c.title]?.score || 0,
                            feedback: detailedRubricFeedback[c.title]?.feedback || 'No specific feedback provided.'
                        })),
                        overallComments: overallCommentText
                    };

                } catch (error) {
                    console.error("Error scoring essay with Gemini rubric:", error);
                    showMessage("Rubric assessment failed. Using fallback analysis. Ensure Gemini API key is valid and service is available.", 'error');
                    // Fallback in case of API error or parsing error
                    let fallbackTotalScore = 0;
                    let fallbackTotalWeight = 0;
                    const fallbackBreakdown = rubricCriteria.map(r => {
                        const score = 3; // Assign a default score of 3 for fallback
                        fallbackTotalScore += (score * parseInt(r.weight || '0'));
                        fallbackTotalWeight += parseInt(r.weight || '0');
                        return {
                            ...r,
                            score: score,
                            feedback: 'Fallback feedback - Gemini service unavailable.'
                        };
                    });
                    // Ensure fallback final score does not exceed 100
                    const finalScore = Math.min(100, Math.round((fallbackTotalScore / (fallbackTotalWeight || 1)) * 100));

                    return {
                        individualScores: {},
                        totalScore: finalScore,
                        breakdown: fallbackBreakdown,
                        overallComments: 'Assessment completed using fallback method - Gemini service unavailable. Results may be less accurate.'
                    };
                } finally {
                    hideMessage();
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = 'Submit for Assessment';
                    lucide.createIcons();
                }
            }

            // --- Submit Assessment ---
            function setupSubmitButton() {
                const submitBtn = document.getElementById('submitBtn');
                const aiDetectionResults = document.getElementById('aiDetectionResults');
                const aiProbability = document.getElementById('aiProbability');
                const aiConfidence = document.getElementById('aiConfidence');
                const aiOverallStatus = document.getElementById('aiOverallStatus');
                const wordCountSpan = document.getElementById('wordCount');
                const sentenceCountSpan = document.getElementById('sentenceCount');
                const avgSentenceLengthSpan = document.getElementById('avgSentenceLength');
                const aiFlagsContainer = document.getElementById('aiFlagsContainer');
                const aiFlagsList = document.getElementById('aiFlags');
                const aiStatusIcon = document.getElementById('aiStatusIcon');

                const rubricAssessmentResults = document.getElementById('rubricAssessmentResults');
                const overallScore = document.getElementById('overallScore');
                const overallCommentsContainer = document.getElementById('overallCommentsContainer');
                const overallComments = document.getElementById('overallComments');
                const rubricBreakdown = document.getElementById('rubricBreakdown');

                submitBtn.addEventListener('click', async () => {
                    const fileInput = document.getElementById('fileInput');
                    const uploadedFile = fileInput.files[0];
                    let extractedDocText = ''; // Ensure this is accessible

                    if (!uploadedFile) {
                        showMessage('Please upload a document first.', 'error');
                        return;
                    }

                    try {
                        const arrayBuffer = await uploadedFile.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        extractedDocText = result.value;
                    } catch (error) {
                        showMessage(`Error reading document: ${error.message}.`, 'error');
                        return;
                    }

                    if (rubricSettings.length === 0) {
                        showMessage('Please add at least one rubric criterion in Teacher Settings.', 'error');
                        return;
                    }

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Processing...';
                    clearResults();

                    try {
                        console.log('Running AI detection with Gemini...');
                        const aiResult = await detectAIContent(extractedDocText);

                        // Display AI Detection Results
                        aiDetectionResults.classList.remove('hidden');
                        aiProbability.textContent = `${aiResult.probability}%`;
                        aiConfidence.textContent = `${aiResult.confidence}%`;
                        wordCountSpan.textContent = aiResult.wordCount;
                        sentenceCountSpan.textContent = aiResult.sentenceCount;
                        avgSentenceLengthSpan.textContent = aiResult.avgSentenceLength;

                        // Status icon and text based on AI probability
                        if (aiResult.probability >= 50) { // Example: 50% and above is considered AI
                            aiStatusIcon.innerHTML = '<i data-lucide="robot" class="h-6 w-6 text-red-600 mr-2"></i>';
                            aiProbability.classList.remove('text-green-600');
                            aiProbability.classList.add('text-red-600');
                            aiOverallStatus.textContent = 'AI Detected';
                            aiOverallStatus.classList.remove('text-green-600');
                            aiOverallStatus.classList.add('text-red-600');
                        } else {
                            aiStatusIcon.innerHTML = '<i data-lucide="user-check" class="h-6 w-6 text-green-600 mr-2"></i>';
                            aiProbability.classList.remove('text-red-600');
                            aiProbability.classList.add('text-green-600');
                            aiOverallStatus.textContent = 'Human Detected';
                            aiOverallStatus.classList.remove('text-red-600');
                            aiOverallStatus.classList.add('text-green-600');
                        }

                        if (aiResult.flags && aiResult.flags.length > 0) {
                            aiFlagsContainer.classList.remove('hidden');
                            aiFlagsList.innerHTML = '';
                            aiResult.flags.forEach(flag => {
                                const li = document.createElement('li');
                                li.className = 'text-orange-600';
                                li.textContent = `• ${flag}`;
                                aiFlagsList.appendChild(li);
                            });
                        } else {
                            aiFlagsContainer.classList.add('hidden');
                        }

                        // Rubric assessment always runs
                        console.log('Running rubric assessment with Gemini...');
                        const rubricResult = await scoreWithGeminiRubric(extractedDocText, rubricSettings);

                        // Display Rubric Assessment Results
                        rubricAssessmentResults.classList.remove('hidden');
                        overallScore.textContent = `${rubricResult.totalScore}%`;
                        overallComments.textContent = rubricResult.overallComments;
                        if (rubricResult.overallComments) {
                            overallCommentsContainer.classList.remove('hidden');
                        } else {
                            overallCommentsContainer.classList.add('hidden');
                        }

                        rubricBreakdown.innerHTML = '';
                        rubricResult.breakdown.forEach(item => {
                            const criterionDiv = document.createElement('div');
                            criterionDiv.className = 'p-4 bg-white border border-blue-200 rounded-lg';
                            criterionDiv.innerHTML = `
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-blue-800">${item.title} (<span class="text-gray-600">${item.weight}%</span>)</h4>
                                    <span class="text-xl font-bold text-blue-600">${item.score}/5</span>
                                </div>
                                <p class="text-sm text-gray-700">${item.feedback}</p>
                            `;
                            rubricBreakdown.appendChild(criterionDiv);
                        });
                        lucide.createIcons(); // Re-render Lucide icons for results
                    } catch (error) {
                        console.error('Overall Assessment Error:', error);
                        showMessage(`An error occurred during assessment: ${error.message}. Please check your Gemini API key and try again.`, 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit for Assessment';
                        lucide.createIcons(); // Ensure all icons are rendered after updates
                    }
                });
            }

            // --- Teacher Settings Functions ---
            function calculateTotalWeight() {
                const totalWeightDisplay = document.getElementById('totalWeightDisplay');
                const totalWeightWarning = document.getElementById('totalWeightWarning');
                const total = rubricSettings.reduce((sum, criterion) => sum + parseInt(criterion.weight || '0'), 0);
                totalWeightDisplay.textContent = total;
                if (total !== 100) {
                    totalWeightWarning.classList.remove('hidden');
                    totalWeightDisplay.classList.add('text-red-600');
                } else {
                    totalWeightWarning.classList.add('hidden');
                    totalWeightDisplay.classList.remove('text-red-600');
                }
            }

            function renderRubricSettings() {
                const rubricSettingsList = document.getElementById('rubricSettingsList');
                rubricSettingsList.innerHTML = ''; // Clear existing list

                rubricSettings.forEach(criterion => {
                    const criterionDiv = document.createElement('div');
                    criterionDiv.className = 'p-4 bg-gray-50 border border-gray-200 rounded-lg flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0 md:space-x-4';
                    criterionDiv.innerHTML = `
                        <div class="flex-grow">
                            <input type="text" value="${criterion.title}" data-id="${criterion.id}" data-field="title"
                                class="w-full text-lg font-medium text-gray-800 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                            <textarea data-id="${criterion.id}" data-field="description"
                                class="w-full text-sm text-gray-600 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="2" placeholder="Description">${criterion.description}</textarea>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="number" value="${criterion.weight}" data-id="${criterion.id}" data-field="weight"
                                class="w-20 px-2 py-1 border border-gray-300 rounded-md text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">%</span>
                            <button data-id="${criterion.id}" class="delete-criterion-btn p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-colors">
                                <i data-lucide="trash-2" class="h-5 w-5"></i>
                            </button>
                        </div>
                    `;
                    rubricSettingsList.appendChild(criterionDiv);
                });

                // Attach event listeners to newly created elements
                rubricSettingsList.querySelectorAll('.delete-criterion-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const idToDelete = event.currentTarget.dataset.id;
                        rubricSettings = rubricSettings.filter(c => c.id !== idToDelete);
                        saveRubricSettings(); // Save to Firestore
                        renderRubricSettings(); // Re-render the list
                    });
                });

                // Use 'input' event for real-time local updates without saving or re-rendering the whole list
                rubricSettingsList.querySelectorAll('input[data-field="title"], textarea[data-field="description"], input[data-field="weight"]').forEach(input => {
                    input.addEventListener('input', (event) => { // Changed from 'change' to 'input'
                        const idToUpdate = event.target.dataset.id;
                        const field = event.target.dataset.field;
                        let value = event.target.value;

                        if (field === 'weight') {
                            const parsedValue = parseInt(value);
                            if (isNaN(parsedValue) || parsedValue < 0) {
                                // Don't revert input, just show message if invalid, user can correct it
                                // showMessage('Weight must be a non-negative number.', 'error');
                            }
                            value = String(parsedValue); // Store as string in local array
                        }

                        const criterion = rubricSettings.find(c => c.id === idToUpdate);
                        if (criterion) {
                            criterion[field] = value;
                            // DO NOT CALL saveRubricSettings() or renderRubricSettings() here
                            // Saving will happen on 'Save Settings Now' button click
                        }
                        calculateTotalWeight(); // Update total weight display in real-time
                    });
                });

                calculateTotalWeight();
                lucide.createIcons(); // Ensure Lucide icons are rendered
            }

            function setupAddCriterionButton() {
                const newCriterionNameInput = document.getElementById('newCriterionName');
                const newCriterionWeightInput = document.getElementById('newCriterionWeight');
                const newCriterionDescriptionInput = document.getElementById('newCriterionDescription');
                const addCriterionBtn = document.getElementById('addCriterionBtn');

                addCriterionBtn.addEventListener('click', () => {
                    const name = newCriterionNameInput.value.trim();
                    const weight = parseInt(newCriterionWeightInput.value);
                    const description = newCriterionDescriptionInput.value.trim();

                    if (!name) {
                        showMessage('Criterion name cannot be empty.', 'error');
                        return;
                    }
                    if (isNaN(weight) || weight < 0) {
                        showMessage('Weight must be a non-negative number.', 'error');
                        return;
                    }

                    const newId = crypto.randomUUID(); // Use UUID for unique IDs
                    rubricSettings.push({ id: newId, title: name, weight: String(weight), description: description }); // Store weight as string
                    saveRubricSettings(); // Save to Firestore
                    renderRubricSettings(); // Re-render the list

                    newCriterionNameInput.value = '';
                    newCriterionWeightInput.value = '0';
                    newCriterionDescriptionInput.value = '';
                    hideMessage();
                });
            }

            function setupSaveSettingsButton() {
                const saveSettingsNowBtn = document.getElementById('saveSettingsNowBtn');
                saveSettingsNowBtn.addEventListener('click', async () => {
                    saveSettingsNowBtn.disabled = true;
                    saveSettingsNowBtn.textContent = 'Saving...';
                    await saveRubricSettings(); // This function already calls calculateTotalWeight() and showMessage()
                    renderRubricSettings(); // Re-render to ensure UI reflects saved state
                    saveSettingsNowBtn.disabled = false;
                    saveSettingsNowBtn.textContent = 'Save Settings Now';
                });
            }


        // Initial setup on window load to ensure all resources and DOM are ready
        window.onload = () => {
            console.log('Mammoth.js loaded status (inside window.onload):', typeof mammoth);

            setupViewSwitching();
            setupFileUpload();
            setupSubmitButton();
            setupAddCriterionButton();
            setupSaveSettingsButton(); // Call the new setup function

            // Initial render of Lucide icons on page load
            lucide.createIcons();
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <i data-lucide="pen-tool" class="h-8 w-8 text-blue-600"></i>
                    <span class="text-xl font-bold text-gray-900">EssayChecker Pro</span>
                </div>
                <div class="flex space-x-4">
                    <button id="studentViewBtn" class="px-4 py-2 rounded-lg transition-colors bg-blue-600 text-white">
                        <i data-lucide="user" class="inline h-4 w-4 mr-2"></i>
                        Student View
                    </button>
                    <button id="teacherViewBtn" class="px-4 py-2 rounded-lg transition-colors text-gray-600 hover:text-blue-600">
                        <i data-lucide="settings" class="inline h-4 w-4 mr-2"></i>
                        Teacher Settings
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-6">
        <div id="studentView" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="text-center mb-8">
                    <i data-lucide="file-text" class="mx-auto h-16 w-16 text-blue-600 mb-4"></i>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Essay Grading System</h1>
                    <p class="text-gray-600">Upload your essay for AI detection and rubric-based evaluation</p>
                </div>

                <div class="mb-8">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                        <i data-lucide="upload" class="mx-auto h-12 w-12 text-gray-400 mb-4"></i>
                        <div class="mb-4">
                            <button id="chooseFileBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Choose DOCX File
                            </button>
                            <input type="file" id="fileInput" accept=".docx" class="hidden">
                        </div>
                        <div id="fileInfo" class="text-sm text-gray-600 hidden">
                            <p>Selected: <span id="fileName"></span></p>
                            <p>Size: <span id="fileSize"></span> KB</p>
                        </div>
                    </div>
                </div>

                <div id="extractedTextPreview" class="mb-8 hidden">
                    <h3 class="text-lg font-semibold mb-2">Document Preview:</h3>
                    <div class="bg-gray-50 p-4 rounded-lg max-h-40 overflow-y-auto">
                        <p id="previewText" class="text-sm text-gray-700"></p>
                    </div>
                </div>

                <div class="text-center">
                    <button id="submitBtn" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>
                        Submit for Assessment
                    </button>
                </div>

                <div id="messageBox" class="mt-4 p-4 rounded-lg hidden"></div>

                <div id="aiDetectionResults" class="mt-8 p-6 bg-gray-50 rounded-lg hidden">
                    <div class="flex items-center mb-4">
                        <span id="aiStatusIcon"></span>
                        <h3 class="text-xl font-semibold">AI Detection Results (Powered by Gemini)</h3>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">AI Probability</p>
                            <p id="aiProbability" class="text-2xl font-bold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Confidence Level</p>
                            <p id="aiConfidence" class="text-lg font-semibold text-blue-600"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Status</p>
                            <p id="aiOverallStatus" class="text-lg font-semibold"></p>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Word Count</p>
                            <p id="wordCount" class="font-semibold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Sentences</p>
                            <p id="sentenceCount" class="font-semibold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Average Sentence Length</p>
                            <p id="avgSentenceLength" class="font-semibold"></p>
                        </div>
                    </div>

                    <div id="aiFlagsContainer" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Detection Flags:</p>
                        <ul id="aiFlags" class="text-sm space-y-1"></ul>
                    </div>
                </div>

                <div id="rubricAssessmentResults" class="mt-8 p-6 bg-blue-50 rounded-lg hidden">
                    <div class="flex items-center mb-4">
                        <i data-lucide="bar-chart-3" class="h-6 w-6 text-blue-600 mr-2"></i>
                        <h3 class="text-xl font-semibold">Rubric Assessment Results (Powered by Gemini)</h3>
                    </div>

                    <div class="text-center mb-6">
                        <div id="overallScore" class="text-4xl font-bold text-blue-600 mb-2"></div>
                        <p class="text-gray-600">Overall Score</p>
                    </div>

                    <div id="overallCommentsContainer" class="mb-6 p-4 bg-white border border-blue-200 rounded-lg hidden">
                        <h4 class="font-medium text-blue-800 mb-2">Overall Comments:</h4>
                        <p id="overallComments" class="text-sm text-gray-700"></p>
                    </div>

                    <div id="rubricBreakdown" class="space-y-4">
                        <!-- Rubric breakdown items will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="teacherSettings" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center mb-6">
                    <i data-lucide="settings" class="h-8 w-8 text-blue-600 mr-3"></i>
                    <h1 class="text-3xl font-bold text-gray-900">Teacher Settings</h1>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">Rubric Criteria</h3>

                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium mb-3">Add New Criterion</h4>
                        <div class="grid md:grid-cols-3 gap-4 mb-3">
                            <input type="text" id="newCriterionName" placeholder="Criterion Title" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="number" id="newCriterionWeight" placeholder="Weight (%)" class="px-3 py-2 border border-gray-300 rounded-lg" value="0" min="0">
                            <button id="addCriterionBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Add Criterion
                            </button>
                        </div>
                        <textarea id="newCriterionDescription" placeholder="Description" class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20 resize-y"></textarea>
                    </div>

                    <div id="rubricSettingsList" class="space-y-4">
                        <!-- Rubric settings items will be inserted here -->
                    </div>

                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            Total Weight: <span id="totalWeightDisplay"></span>%
                            <span id="totalWeightWarning" class="font-semibold hidden"> (Must be 100%)</span>
                        </p>
                    </div>

                    <!-- New Save Settings Button -->
                    <div class="mt-8 text-center">
                        <button id="saveSettingsNowBtn" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 disabled:opacity-70 disabled:cursor-not-allowed transition-colors">
                            Save Settings Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>
